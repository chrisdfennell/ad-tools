{% extends 'base.html' %}
{% block title %}Compare Users{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('dashboard.index') }}" class="text-decoration-none text-muted">Dashboard</a>
<span class="mx-2">/</span>
<a href="{{ url_for('users.list_users') }}" class="text-decoration-none text-muted">Users</a>
<span class="mx-2">/</span>
<span>Compare</span>
{% endblock %}

{% block content %}
<h4 class="mb-4"><i class="fas fa-columns me-2"></i>Account Comparison</h4>

<!-- User selection -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('users.compare') }}" class="row g-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label fw-bold">User 1</label>
                <select name="user1" class="form-select">
                    <option value="">Select user...</option>
                    {% for u in user_list %}
                    <option value="{{ u.sam }}" {% if sam1 == u.sam %}selected{% endif %}>{{ u.sam }} — {{ u.display_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label fw-bold">User 2</label>
                <select name="user2" class="form-select">
                    <option value="">Select user...</option>
                    {% for u in user_list %}
                    <option value="{{ u.sam }}" {% if sam2 == u.sam %}selected{% endif %}>{{ u.sam }} — {{ u.display_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-arrows-alt-h me-1"></i>Compare
                </button>
            </div>
        </form>
    </div>
</div>

{% if diff %}
<!-- Attribute comparison -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-list me-1"></i>Attribute Comparison
    </div>
    <div class="card-body p-0">
        <table class="table table-sm mb-0">
            <thead>
                <tr>
                    <th style="width:25%">Attribute</th>
                    <th style="width:35%">{{ user1.sam }}</th>
                    <th style="width:5%"></th>
                    <th style="width:35%">{{ user2.sam }}</th>
                </tr>
            </thead>
            <tbody>
                {% for row in diff %}
                <tr class="{% if not row.match %}table-warning{% endif %}">
                    <td class="fw-bold">{{ row.label }}</td>
                    <td>{{ row.val1 or '—' }}</td>
                    <td class="text-center">
                        {% if row.match %}
                        <i class="fas fa-equals text-success"></i>
                        {% else %}
                        <i class="fas fa-not-equal text-danger"></i>
                        {% endif %}
                    </td>
                    <td>{{ row.val2 or '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Group membership comparison -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-layer-group me-1"></i>Group Membership Comparison
    </div>
    <div class="card-body p-0">
        <table class="table table-sm mb-0">
            <thead>
                <tr>
                    <th>Group</th>
                    <th style="width:15%" class="text-center">{{ user1.sam }}</th>
                    <th style="width:15%" class="text-center">{{ user2.sam }}</th>
                </tr>
            </thead>
            <tbody>
                {% for g in group_diff %}
                <tr class="{% if g.in1 != g.in2 %}table-warning{% endif %}">
                    <td>{{ g.name }}</td>
                    <td class="text-center">
                        {% if g.in1 %}
                        <i class="fas fa-check text-success"></i>
                        {% else %}
                        <i class="fas fa-times text-danger"></i>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if g.in2 %}
                        <i class="fas fa-check text-success"></i>
                        {% else %}
                        <i class="fas fa-times text-danger"></i>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not group_diff %}
                <tr><td colspan="3" class="text-muted text-center py-3">No group memberships to compare.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{% elif sam1 or sam2 %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>
    Please select two valid users to compare.
</div>
{% else %}
<div class="text-center text-muted py-5">
    <i class="fas fa-columns fa-3x mb-3"></i>
    <p>Select two users above to compare their attributes and group memberships side by side.</p>
</div>
{% endif %}
{% endblock %}
